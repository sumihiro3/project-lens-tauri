# 【実装計画】3.2: 設計の変更・統合

## 📋 実装計画概要
**対象タスク**: 3.2 - 設計の変更・統合
**計画作成日**: 2025年7月25日
**推定工数**: 3-4日
**要件参照**: 設計統合要件

## 🎯 タスク概要
技術仕様書とコード実装の整合性確保、データモデル設計の統一化、アーキテクチャドキュメントの更新、およびタスク依存関係の最適化を行い、複数Backlogワークスペース管理に向けた統一的な設計基盤を確立する。

**実装内容**:
- 技術仕様書とコード実装の整合性確保
- データモデル設計の統一化
- アーキテクチャドキュメントの更新
- タスク依存関係の最適化

## 📖 要件詳細

### 設計統合の主要要件

#### **1. 複数Backlogワークスペース管理統合**
- **統合要件**: 技術仕様書のworkspacesテーブル設計とコード実装の統合
- **制約**: 暗号化APIキー保存とMCP Server設定反映の一体化実装が必要

#### **2. セキュリティ設計統合**
- **統合要件**: AES-256-GCM暗号化仕様とSecureString実装の統合
- **制約**: メモリ安全性確保とAPIキー管理の統一設計が必要

#### **3. データモデル設計統一**
- **統合要件**: Ticket構造でworkspace_idとraw_dataフィールドの追加統合
- **制約**: AIAnalysis構造の両文書間での完全統合が必要

#### **4. エラーハンドリング設計統合**
- **統合要件**: DockerServiceStateとブロッキングダイアログの標準化
- **制約**: 段階的エスカレーション（通知→ダイアログ→ブロック）の統一実装

### 受け入れ基準

1. **WHEN** 技術仕様書とコード実装の差分分析が完了した時 **THEN** システムは不整合箇所を特定し修正計画を提示する
2. **WHEN** データモデル統一が完了した時 **THEN** システムは技術仕様書で定義されたすべてのフィールドを含む統一的なデータ構造を提供する
3. **WHEN** アーキテクチャドキュメントが更新された時 **THEN** システムは実際の実装と一致したアーキテクチャ図とデータフロー図を提供する
4. **WHEN** タスク依存関係が最適化された時 **THEN** システムは機能別に分離された効率的な実装順序を提供する

## 🏗️ 技術設計

### アプローチ
1. **差分分析ファースト**: 技術仕様書とコード実装の詳細な差分分析を実施
2. **段階的統合**: 深刻度別に分類して優先度を付けた段階的統合実施
3. **ドキュメント駆動**: 実装と一致したドキュメント更新による整合性確保
4. **検証重視**: 各統合ステップでの検証と品質保証の徹底

### 影響範囲

#### **🔴 HIGH: 緊急修正が必要**
- `/Users/sumihiro/projects/ProjectLens/src-tauri/src/storage/schema.rs` - 技術仕様書準拠への全面改修
- `/Users/sumihiro/projects/ProjectLens/src-tauri/src/models/mod.rs` - workspace_id、raw_dataフィールド追加

#### **🟡 MEDIUM: 統合改修が必要**
- `/Users/sumihiro/projects/ProjectLens/src-tauri/src/storage/repository.rs` - 新スキーマ対応CRUD実装
- `/Users/sumihiro/projects/ProjectLens/docs/architecture/system-overview.md` - アーキテクチャ図更新

#### **🟢 LOW: 段階的改善**
- `/Users/sumihiro/projects/ProjectLens/src/types/settings.ts` - 統合設定管理用型定義
- `/Users/sumihiro/projects/ProjectLens/src/stores/settingsStore.ts` - セキュアストレージ統合

### 依存関係
**前提タスク（完了が必要）:**
- [x] 3.1: 暗号化サービスの作成（完了済み）

**並行実行可能なタスク:**
- なし（設計統合は他タスクの基盤となるため単独実行必須）

**このタスクをブロックしているタスク:**
- 4.1: DB環境設定・スキーマ管理
- 4.2: 暗号化された認証情報の保存
- 4.3: その他ユーザー設定等の保存
- 4.4: コアデータモデルの定義

## ✅ 実装ステップ

### Phase 1: 差分分析と問題特定（Day 1）
- [x] **1.1**: 技術仕様書とコード実装の詳細差分分析
  - スキーマ定義の差分一覧作成
  - データモデル構造の差分一覧作成
  - エラーハンドリングパターンの差分一覧作成
  - セキュリティ実装の差分一覧作成

- [x] **1.2**: 深刻度別問題分類と優先度設定
  - 🔴 HIGH: アプリケーション動作に致命的影響
  - 🟡 MEDIUM: 機能統合に重要な影響
  - 🟢 LOW: 品質向上・保守性向上

### Phase 2: データモデル設計統一（Day 1-2）
- [x] **2.1**: Ticketモデルの技術仕様書準拠更新
  - workspace_idフィールドの追加
  - raw_dataフィールド（JSON）の追加
  - DateTime型の統一（TEXT形式への変更）
  - 外部キー制約の追加

- [x] **2.2**: AI分析用データモデルの追加実装
  - AIAnalysis構造体の完全実装
  - UrgencyFactors構造体の実装
  - ProjectWeight構造体の技術仕様書準拠更新

- [x] **2.3**: BacklogWorkspaceConfig構造体の暗号化対応拡張
  - api_key_encryptedフィールドの追加
  - encryption_versionフィールドの追加
  - セキュアメモリ管理フィールドの統合

### Phase 3: スキーマ設計統合（Day 2-3）
- [x] **3.1**: 技術仕様書準拠のSQLiteスキーマ実装
  - workspacesテーブルの追加実装
  - project_weightsテーブルの追加実装
  - ai_analysesテーブルの追加実装
  - 既存テーブルの暗号化対応修正

- [x] **3.2**: インデックス最適化とパフォーマンス設計
  - 複数ワークスペース検索用インデックス
  - AI分析クエリ最適化インデックス
  - 外部キー制約の適切な設定

### Phase 4: エラーハンドリング設計統合（Day 3）
- [x] **4.1**: 段階的エラー表示パターンの標準化
  - 通知システムの階層設計統一
  - ブロッキングダイアログのUXパターン統一
  - 重複通知防止機構の標準化

- [x] **4.2**: Store間通信パターンの統一
  - カスタムイベントベース通信の標準化
  - 循環参照回避パターンの統一
  - セッション管理とタイムアウト処理の統一

### Phase 5: アーキテクチャドキュメント更新（Day 3-4）
- [x] **5.1**: システムアーキテクチャ図の更新
  - 実装済み vs 未実装の明確化
  - 暗号化フローの詳細化
  - Store間通信パターンの図解更新

- [x] **5.2**: データフロー図の更新
  - 複数ワークスペース管理フローの追加
  - セキュアストレージフローの詳細化
  - AI分析処理フローの明確化

### Phase 6: 統合検証とドキュメント完成（Day 4）
- [x] **6.1**: 設計整合性の検証
  - 技術仕様書との完全一致確認
  - データモデル整合性の検証
  - アーキテクチャドキュメントの精度確認

- [x] **6.2**: タスク依存関係の最適化
  - 新しいタスク構造での依存関係図作成
  - 並行開発可能なタスクの特定
  - 実装順序の最適化提案

## 🧪 テスト計画

### テスト戦略
**ドキュメント検証重視**: 実装とドキュメントの整合性確認を最優先とし、設計品質の向上を図る

### テスト種別
- **設計整合性テスト**: 技術仕様書とコード実装の一致度検証
- **データモデル検証テスト**: フィールド定義・制約の正確性確認
- **アーキテクチャ検証テスト**: 図表と実装の一致度確認

### テスト網羅度
- **整合性カバレッジ**: 技術仕様書の定義項目100%確認
- **ドキュメント精度**: アーキテクチャ図の実装反映度100%
- **設計品質**: データモデル・スキーマの制約完全性確認

## ⚠️ リスクと考慮事項

### 技術的リスク
- **大規模変更リスク**: スキーマとモデルの大幅変更による既存機能への影響
- **整合性維持リスク**: 複数ファイルにまたがる変更での整合性確保の難しさ
- **ドキュメント陳腐化リスク**: 今後の開発でのドキュメント更新忘れ

### 対策
- **段階的変更**: Phase別の小刻みな変更と検証
- **Cross-referenceチェック**: 各Phase完了時の相互参照整合性確認
- **ドキュメント自動化**: 可能な限りコードからの自動生成検討

## 📚 参考資料

### 既存実装参考
- **暗号化サービス**: `src-tauri/src/crypto/crypto_service.rs` - 優秀な実装例として活用
- **エラーハンドリング**: `src/stores/dockerStore.ts` - 統合パターンの参考
- **データモデル**: `src-tauri/src/models/mod.rs` - 現在の実装ベース

### 技術仕様書参照
- **データベーススキーマ**: `technical-specifications.md` L254-301
- **暗号化仕様**: `technical-specifications.md` L305-342
- **エラーハンドリング仕様**: `technical-specifications.md` L108-225

## 🏗️ プロジェクト技術情報
**技術スタック**: Tauri + Vue.js (Nuxt3) + TypeScript + Pug, Rust バックエンド
**AI統合**: Mastra (OpenAI/Claude/Gemini 対応)
**状態管理**: Pinia
**データ保存**: SQLite (ローカルのみ)
**外部連携**: Backlog MCP Server (Docker経由)

## 📋 アーキテクチャ参照
- **レイヤー構成**: プレゼンテーション層(Vue/Nuxt3) → アプリケーション層(Rust) → データ層(SQLite)
- **セキュリティ**: APIキー暗号化保存、ローカルのみでのデータ処理
- **パフォーマンス**: 軽量起動、低メモリ使用量重視

## 🔗 関連タスク

### 依存関係マップ
```
3.1 [完了] 暗号化サービス
  ↓
3.2 [実装中] 設計の変更・統合 ← このタスク
  ↓
4.1 DB環境設定・スキーマ管理
  ↓
4.2 暗号化された認証情報の保存
  ↓
4.3 その他ユーザー設定等の保存
  ↓
4.4 コアデータモデルの定義
```

### 関連タスク詳細
- **4.1 DB環境設定・スキーマ管理**: 統合されたスキーマ設計を基に実装
- **4.2 暗号化された認証情報の保存**: 統合されたセキュリティ設計を基に実装
- **4.3 その他ユーザー設定等の保存**: 統合されたデータモデルを基に実装
- **4.4 コアデータモデルの定義**: 統合されたモデル設計を基に実装

## ✅ 完成条件 (Definition of Done)
- [x] 技術仕様書とコード実装が100%一致している
- [x] データモデルがすべての必要フィールドを含んでいる
- [x] スキーマ設計が技術仕様書に完全準拠している
- [x] エラーハンドリングパターンが統一されている
- [x] アーキテクチャドキュメントが実装と一致している
- [x] タスク依存関係が最適化されている
- [x] 設計整合性テストがすべて通過している
- [x] 後続タスクの実装準備が完了している

## 📝 レビューチェックリスト

### 設計品質
- [x] 技術仕様書との整合性が100%確保されている
- [x] データモデルが拡張性を考慮した設計になっている
- [x] セキュリティ設計が一貫している
- [x] エラーハンドリングが標準化されている

### ドキュメント品質
- [x] アーキテクチャ図が実装を正確に反映している
- [x] データフロー図が最新の設計を反映している
- [x] 技術仕様書の記述が実装と一致している
- [x] 依存関係図が正確である

### 実装準備
- [x] 後続タスクの要件が明確に定義されている
- [x] 並行開発可能なタスクが特定されている
- [x] 実装順序が最適化されている
- [x] リスクが適切に識別・対策されている

## 📈 期待される成果

### 技術的価値
- **設計一貫性**: 技術仕様書とコード実装の完全な整合性確保
- **開発効率**: 統一された設計による後続タスクの開発効率向上
- **品質向上**: 標準化されたパターンによるコード品質向上

### プロジェクト価値
- **実装加速**: 設計統合により後続タスクの実装速度大幅向上
- **リスク軽減**: 設計不整合によるバグや手戻りの防止
- **保守性向上**: 統一されたアーキテクチャによる長期保守性確保

### チーム価値
- **開発体験向上**: 明確な設計指針による開発者体験向上
- **知識共有**: 整合性の取れたドキュメントによる知識共有促進
- **品質文化**: 設計重視の開発文化構築

---

**この設計統合により、ProjectLensは技術仕様書と実装が完全に一致した、複数Backlogワークスペース管理に最適化された統一的な設計基盤を確立します。**