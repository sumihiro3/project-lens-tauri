# 【実装計画】4.2: 暗号化された認証情報の保存

## 📋 実装計画概要
**対象タスク**: 4.2 - 暗号化された認証情報の保存  
**計画作成日**: 2025年7月31日  
**推定工数**: 1.5日  
**要件参照**: 6.1, 6.2, 6.3

## 🎯 タスク概要
マスターパスワード管理機能とBacklogワークスペース認証情報・AIプロバイダーAPIキーの暗号化保存機能を実装し、セキュアなデータアクセス層を作成する。Task 3.1で実装済みのAES-256-GCM暗号化サービスと、Task 3.2で完成したデータモデル・スキーマを活用して効率的に実装を行う。

### 実装準備状況
- ✅ **AES-256-GCM暗号化サービス完全実装済み**（Task 3.1完了）
- ✅ **encryption_version対応データモデル実装済み**（Task 3.2完了）
- ✅ **SQLiteスキーマv2・Repository層実装済み**（Task 4.1完了）

### 残作業項目
- 🎯 マスターパスワード管理機能を実装
- 🎯 Backlogワークスペース認証情報の暗号化保存機能を作成
- 🎯 AIプロバイダーAPIキーの暗号化保存機能を実装
- 🎯 セキュアなデータアクセス層を作成

## 📖 要件詳細

### 要件6.1: セキュアな認証情報管理
**ユーザーストーリー**: セキュリティ担当者として、APIキーやアクセストークンが安全に管理されることを確認したいので、暗号化された保存機能を実装したい

#### 受け入れ基準
1. **暗号化保存**: APIキーやアクセストークンが入力された時、システムは情報を暗号化してローカルファイルシステムに保存する
2. **メモリ使用制限**: 暗号化された認証情報を使用する時、システムは復号化してメモリ上でのみ使用し、外部に送信しない
3. **メモリクリア**: アプリケーションが終了した時、システムはメモリ上の認証情報をクリアする

### 要件6.2: Backlog MCP Server連携（暗号化部分）
**ユーザーストーリー**: システム管理者として、複数のBacklogワークスペースのAPIを通じてチケット情報を安全に取得したいので、MCP Serverを介した連携を実現したい

#### 受け入れ基準
1. **設定画面**: ユーザーが設定画面でBacklog設定を開いた時、システムは複数のワークスペース（BACKLOG_DOMAIN、BACKLOG_API_KEY）を設定できるインターフェースを提供する
2. **暗号化保存**: 新しいワークスペースが追加された時、システムは設定を暗号化してローカルに保存し、MCP Serverの設定に反映する

### 要件6.3: マルチAIプロバイダー対応（暗号化部分）
**ユーザーストーリー**: 開発者として、複数のAIプロバイダー（OpenAI、Claude、Gemini）から選択したいので、自分の環境や予算に合わせてAIを利用できるようにしたい

#### 受け入れ基準
1. **プロバイダー選択**: ユーザーが設定画面でAI設定を開いた時、システムはOpenAI、Anthropic Claude、Google Gemini の選択肢を表示する
2. **APIキー暗号化**: APIキーが入力された時、システムはキーを暗号化してローカルに保存する

## 🏗️ 技術設計

### アプローチ
1. **既存実装の活用**: Task 3.1で完成したCryptoServiceとTask 3.2で統合されたデータモデルを最大限活用
2. **マスターパスワード管理**: アプリケーション起動時のマスターパスワード入力と検証機能
3. **暗号化データアクセス層**: Repository層とCryptoServiceを統合したセキュアなデータアクセス
4. **メモリ安全性**: SecureString/SecureBytes活用による機密情報の安全な取り扱い

### 影響範囲
#### 新規作成ファイル
- `src-tauri/src/storage/secure_repository.rs` - セキュアデータアクセス層
- `src-tauri/src/auth/master_password.rs` - マスターパスワード管理
- `src-tauri/src/auth/mod.rs` - 認証モジュール

#### 変更ファイル
- `src-tauri/src/lib.rs` - Tauri Command追加（認証関連）
- `src-tauri/src/storage/mod.rs` - SecureRepository統合
- `src-tauri/src/models/mod.rs` - AIProviderConfig追加

#### フロントエンド統合
- 設定画面でのマスターパスワード入力UI
- Backlog設定・AI設定でのセキュアな入力フォーム

### 依存関係
**前提タスク（完了済み）:**
- ✅ Task 3.1: AES-256-GCM暗号化サービス実装
- ✅ Task 3.2: データモデル統合・スキーマv2実装  
- ✅ Task 4.1: データベース基盤・Repository層実装

**並行実行可能なタスク:**
- Task 4.3: その他ユーザー設定等の保存
- Task 4.4: コアデータモデルの定義（AIProviderConfig部分のみ残存）

**このタスクをブロックしているタスク:**
- Task 5.1: ワークスペース管理UI（マスターパスワード認証UI必要）
- Task 7.1: AIプロバイダー抽象化層（暗号化されたAPIキー管理統合）

## ✅ 実装ステップ

### Phase 1: マスターパスワード管理機能 (0.5日)
- [ ] `src-tauri/src/auth/mod.rs`とディレクトリ構造作成
- [ ] `src-tauri/src/auth/master_password.rs`でマスターパスワード管理機能実装
  - [ ] パスワード設定・検証機能
  - [ ] セッション管理（アプリ起動中のパスワード保持）
  - [ ] タイムアウト機能（一定時間後の再認証要求）
- [ ] Tauri Commands実装（set_master_password, verify_master_password, clear_session）

### Phase 2: AIProviderConfigデータモデル完成 (0.2日)
- [ ] `src-tauri/src/models/mod.rs`にAIProviderConfig構造体追加
  - [ ] OpenAI、Claude、Gemini対応
  - [ ] 暗号化されたAPIキー保存フィールド
  - [ ] encryption_version対応

### Phase 3: セキュアデータアクセス層実装 (0.5日)
- [ ] `src-tauri/src/storage/secure_repository.rs`実装
  - [ ] SecureRepository構造体作成（Repository + CryptoService統合）
  - [ ] Backlogワークスペース設定の暗号化CRUD操作
  - [ ] AIプロバイダー設定の暗号化CRUD操作
  - [ ] マスターパスワード検証付きアクセス制御

### Phase 4: 暗号化機能統合とテスト (0.3日)
- [ ] Tauri Commands実装
  - [ ] save_backlog_workspace_secure, get_backlog_workspaces_secure
  - [ ] save_ai_provider_config_secure, get_ai_provider_configs_secure
- [ ] 統合テスト実装
  - [ ] マスターパスワード機能テスト
  - [ ] 暗号化保存・取得の往復テスト
  - [ ] 不正パスワードでのアクセス拒否テスト
  - [ ] メモリリーク防止テスト

## 🧪 テスト計画

### テスト戦略
1. **ユニットテスト**: 各機能の個別動作確認
2. **統合テスト**: CryptoService + Repository + MasterPassword連携テスト
3. **セキュリティテスト**: 不正アクセスの拒否、メモリクリア動作確認
4. **パフォーマンステスト**: 暗号化・復号化処理時間の測定

### テスト種別
#### ユニットテスト
- **MasterPassword機能**: パスワード設定・検証・セッション管理
- **SecureRepository機能**: 暗号化CRUD操作の正確性
- **AIProviderConfig**: データモデルの妥当性検証

#### 統合テスト
- **認証フロー全体**: マスターパスワード → 暗号化データアクセス → メモリクリア
- **複数設定管理**: 複数ワークスペース・複数AIプロバイダーの同時暗号化管理
- **エラーハンドリング**: 不正パスワード・改ざんデータの検知

#### セキュリティテスト
- **メモリ安全性**: SecureString/SecureBytesによる機密情報クリア動作
- **暗号化強度**: AES-256-GCM + PBKDF2による暗号化の堅牢性
- **認証バイパス**: マスターパスワード未入力でのアクセス拒否

### テスト網羅度
- **機能カバレッジ**: 最低90%を目標（セキュリティ機能のため高水準）
- **エラーパスのテスト**: 全エラーケースとセキュリティ例外の検証
- **パフォーマンステスト**: 暗号化処理が5秒以内、10件の設定管理が30秒以内

## ⚠️ リスクと考慮事項

### セキュリティリスク
1. **マスターパスワード忘れ**: 回復手段がない場合の全データ損失 → ユーザーへの明確な警告表示
2. **メモリダンプ攻撃**: プロセスメモリからの機密情報漏洩 → SecureString活用で対策
3. **スワップファイル漏洩**: OSによる仮想メモリスワップ → mlock対応を検討（今回は除外）

### 技術的リスク
1. **PBKDF2性能**: 100,000回イテレーションによる処理遅延 → 非同期処理で対応
2. **プラットフォーム差異**: OS別のセキュア処理の違い → Rust標準ライブラリ活用で統一
3. **データ互換性**: 暗号化バージョン変更時の既存データ移行 → encryption_version管理で対応

### 運用リスク
1. **設定データ損失**: 暗号化データの破損による全設定喪失 → バックアップ機能（Task 4.3で対応）
2. **パスワード複雑性**: 弱いマスターパスワードによるセキュリティ低下 → パスワード強度チェック機能

## 📚 参考資料

### 既存実装
- **CryptoService**: `src-tauri/src/crypto/service.rs` - AES-256-GCM暗号化実装
- **Repository層**: `src-tauri/src/storage/repository.rs` - データベース操作パターン  
- **データモデル**: `src-tauri/src/models/mod.rs` - BacklogWorkspaceConfig実装例

### セキュリティベストプラクティス
- **NIST SP 800-132**: PBKDF2推奨設定（100,000回イテレーション）
- **OWASP**: 機密情報のメモリ管理ガイドライン
- **Ring暗号化ライブラリ**: AES-GCM認証付き暗号化の実装パターン

## 🏗️ プロジェクト技術情報
**技術スタック**: Tauri + Vue.js (Nuxt3) + TypeScript + Pug, Rust バックエンド  
**暗号化**: AES-256-GCM + PBKDF2-HMAC-SHA256 (100,000 iterations)  
**セキュリティ**: SecureBytes/SecureString による機密情報管理  
**データ保存**: SQLite (ローカルのみ) + 暗号化レイヤー  
**外部連携**: Backlog MCP Server (Docker経由)

## 📋 アーキテクチャ参照
- **セキュリティ層**: CryptoService (AES-256-GCM) → SecureRepository → Repository → SQLite
- **認証管理**: MasterPassword → SessionManager → SecureDataAccess
- **メモリ安全**: SecureString/SecureBytes → 自動メモリクリア → GC回避

## 🔗 関連タスク

### 依存関係マップ
```
Task 3.1 (完了) → Task 4.2 (実装中)
Task 3.2 (完了) ↗     ↓
Task 4.1 (完了) → Task 4.2 → Task 5.1 (ワークスペース管理UI)
                        ↓
                   Task 7.1 (AIプロバイダー統合)
```

### 関連タスク詳細
- **Task 5.1**: マスターパスワード認証UIとワークスペース設定画面の統合
- **Task 7.1**: 暗号化されたAPIキー管理とAIプロバイダー抽象化層の連携
- **Task 4.3**: 設定バックアップ・復元機能（暗号化対応）

## ✅ 完成条件 (Definition of Done)
- [ ] マスターパスワード設定・検証機能が正常動作する
- [ ] Backlogワークスペース設定の暗号化保存・取得が正常動作する
- [ ] AIプロバイダー設定の暗号化保存・取得が正常動作する
- [ ] 不正パスワードでのアクセスが適切に拒否される
- [ ] 全テストケースが通過する（最低90%カバレッジ）
- [ ] メモリクリア機能が正常動作する（SecureString/SecureBytes）
- [ ] 暗号化・復号化パフォーマンスが要件を満たす（5秒以内）
- [ ] セキュリティレビューが完了している
- [ ] 統合テストで既存機能に問題が発生しない

## 📝 レビューチェックリスト

### セキュリティ確認
- [ ] マスターパスワードが平文でログ出力されていない
- [ ] 暗号化キーがメモリ上に長時間残存していない
- [ ] SecureString/SecureBytesが適切に使用されている
- [ ] エラーメッセージから機密情報が漏洩していない

### コード品質
- [ ] CryptoServiceが適切に活用されている
- [ ] Repository層との統合が正しく実装されている
- [ ] エラーハンドリングが包括的に実装されている
- [ ] 非同期処理でUIブロッキングが発生していない

### アーキテクチャ準拠
- [ ] Task 3.1/3.2/4.1の既存実装パターンに従っている
- [ ] データモデルが技術仕様書に準拠している
- [ ] レイヤー分離が適切に実装されている
- [ ] CLAUDE.mdのコーディング規約に準拠している

### テスト
- [ ] セキュリティテストが網羅的である
- [ ] パフォーマンステストが実装されている
- [ ] エッジケース（空パスワード等）がテストされている
- [ ] 統合テストで既存機能との互換性が確認されている