# 【実装計画】4.1: DB環境設定・スキーマ管理

## 📋 実装計画概要
**対象タスク**: 4.1 - DB環境設定・スキーマ管理  
**計画作成日**: 2025年7月29日  
**推定工数**: 0.5日（スキーマ完了により大幅短縮）  
**要件参照**: 9.1, 9.2（オフライン対応とキャッシュ機能）

## 🎯 タスク概要
Task 3.2で先行実装されたSQLiteスキーマとマイグレーション機能を基盤として、データベース接続・トランザクション管理機能を完成させる。この実装により、完全なストレージ層基盤を提供し、後続のタスク4.2-4.4の前提条件を満たす。

**実装済み（Task 3.2完了分）:**
- ✅ 技術仕様書準拠のSQLiteスキーマv2実装（6テーブル + 9インデックス）
- ✅ マイグレーション機能（v1→v2移行対応）
- ✅ データモデル統合（Ticket・AIAnalysis・UrgencyFactors・ProjectWeight・BacklogWorkspaceConfig）

**残作業:**
- 🎯 データベース接続・トランザクション管理機能（repository.rs更新）
- 🎯 接続プール管理とエラーハンドリング統合
- 🎯 データベース初期化とマイグレーション実行機能

## 📖 要件詳細

### 要件9.1：キャッシュ機能
**受け入れ基準:**
1. WHEN チケット情報が取得された時 THEN システムは情報をローカルキャッシュに保存する
2. データベースの適切な接続プール管理により並行アクセスを処理する
3. トランザクション機能により整合性を保証する

### 要件9.2：オフライン状態検出
**受け入れ基準:**
1. データベース接続エラー時の適切なエラーハンドリング
2. オフライン状態でもキャッシュデータを安全に読み取り可能
3. 接続復旧時の自動スキーマ確認とマイグレーション実行

## 🏗️ 技術設計

### アプローチ
既存のスキーマ定義（src-tauri/src/storage/schema.rs）を基盤として、repository.rsにデータベース接続・管理機能を実装する。Task 3.2で実装済みのスキーマv2とマイグレーション機能との完全統合を図る。

### 影響範囲
**更新対象ファイル:**
- `src-tauri/src/storage/repository.rs` - データベース接続・CRUD操作の完全実装
- `src-tauri/src/storage/service.rs` - ストレージサービス層の接続機能統合
- `src-tauri/src/storage/mod.rs` - モジュール構成の最終調整

**参照するファイル:**
- `src-tauri/src/storage/schema.rs` - 既存スキーマとマイグレーション定義
- `src-tauri/src/models/mod.rs` - 統合済みデータモデル

### 依存関係
**前提タスク（完了済み）:**
- ✅ Task 3.2: 設計統合とアーキテクチャ更新（SQLiteスキーマv2・データモデル統合完了）

**並行実行可能なタスク:**
- Task 4.4: コアデータモデルの定義（主要部分は3.2で先行実装済み）

**このタスクをブロックしているタスク:**
- Task 4.2: 暗号化された認証情報の保存（DB接続機能が前提）
- Task 4.3: その他ユーザー設定等の保存（DB接続機能が前提）

## ✅ 実装ステップ

### Phase 1: データベース接続機能実装（推定: 2時間）
- [ ] `DatabaseConnection`構造体とコネクションプール実装
- [ ] スキーマ初期化とマイグレーション実行機能の統合
- [ ] `get_db_version()`とバージョン管理機能実装
- [ ] 接続エラーハンドリングとリトライロジック

### Phase 2: CRUD操作基盤実装（推定: 2時間）
- [ ] `ConfigRepository`の完全実装（設定管理）
- [ ] `TicketRepository`の基本CRUD操作実装
- [ ] `WorkspaceRepository`の実装（暗号化認証情報対応）
- [ ] `ProjectWeightRepository`の実装

### Phase 3: トランザクション管理（推定: 1時間）
- [ ] トランザクション管理機能の実装
- [ ] バッチ操作対応（複数テーブル更新）
- [ ] デッドロック検出とリトライ機能

### Phase 4: 統合テストと検証（推定: 1時間）
- [ ] データベース初期化テスト
- [ ] マイグレーション実行テスト（v1→v2）
- [ ] CRUD操作の動作確認
- [ ] エラーハンドリングテスト

## 🧪 テスト計画

### テスト戦略
既存のスキーマ実装（Task 3.2）を前提として、データベース接続・操作機能のテストに集中する。

### テスト種別

#### ユニットテスト
- **データベース接続テスト**: 正常接続・接続失敗・リトライ機能
- **CRUD操作テスト**: 各Repository実装の基本操作
- **トランザクションテスト**: コミット・ロールバック機能
- **マイグレーションテスト**: v1→v2移行処理

#### 統合テスト
- **スキーマ初期化テスト**: 新規DB作成時のスキーマ適用
- **データ永続化テスト**: 実際のファイルシステムでの保存・取得
- **エラー回復テスト**: 接続断→復旧時の動作確認

#### パフォーマンステスト
- **並行アクセステスト**: 複数接続での同時読み書き
- **大量データテスト**: 10,000チケットでの読み書き性能
- **メモリ使用量テスト**: 長時間稼働時のメモリリーク検証

### テスト網羅度
- **機能カバレッジ**: 最低85%を目標（接続・CRUD・トランザクション）
- **エラーパスのテスト**: DB接続エラー・SQL実行エラー・トランザクション失敗
- **パフォーマンステスト**: 接続プール効率・クエリ応答時間・メモリ使用量

## ⚠️ リスクと考慮事項

### 技術リスク
1. **SQLiteファイルロック**: 複数プロセスアクセス時の排他制御
   - **対策**: 適切なタイムアウト設定とリトライロジック実装

2. **マイグレーション失敗**: 既存データの破損リスク
   - **対策**: バックアップ作成とロールバック機能

3. **メモリ使用量**: 大量データ読み込み時のメモリ不足
   - **対策**: チャンク処理とストリーミング読み込み

### 運用リスク
1. **データ整合性**: 並行更新時の競合状態
   - **対策**: 適切なトランザクション分離レベル設定

2. **ファイルサイズ増大**: 長期使用でのDBファイル肥大化
   - **対策**: VACUUM実行とデータ削除ポリシー実装

## 📚 参考資料

### 既存実装
- `src-tauri/src/storage/schema.rs` - スキーマv2定義とマイグレーション（Task 3.2実装）
- `src-tauri/src/models/mod.rs` - 統合済みデータモデル（Task 3.2実装）
- `src-tauri/src/storage/repository.rs` - 現在の基本実装

### 技術仕様参照
- `.kiro/specs/multi-project-dashboard/technical-specifications.md` - SQLiteスキーマ仕様
- `.kiro/specs/multi-project-dashboard/design.md` - データ永続化設計

## 🏗️ プロジェクト技術情報
**技術スタック**: Tauri + Vue.js (Nuxt3) + TypeScript + Pug, Rust バックエンド  
**データベース**: SQLite（ローカルのみ）  
**状態管理**: Pinia  
**データ保存**: 暗号化ローカルストレージ  

## 📋 アーキテクチャ参照
- **レイヤー構成**: プレゼンテーション層(Vue/Nuxt3) → アプリケーション層(Rust) → データ層(SQLite)
- **データフロー**: MCP Server → AIAnalysis → ローカルキャッシュ → UI表示
- **セキュリティ**: 認証情報暗号化、ローカルのみでのデータ処理

## 🔗 関連タスク

### 依存関係マップ
```
Task 3.2 (完了) → Task 4.1 → Task 4.2, 4.3, 4.4
                              ↓
                          Task 5.1, 5.2 (UI実装)
                              ↓
                          Task 6.1, 6.2 (MCP通信)
```

### 関連タスク詳細
- **Task 4.2**: 暗号化認証情報保存（DB接続機能が前提）
- **Task 4.3**: ユーザー設定保存（DB接続機能が前提）  
- **Task 4.4**: データモデル完成（基盤部分は3.2完了、DB連携部分が残存）

## ✅ 完成条件 (Definition of Done)
- [ ] データベース接続・切断機能が正常に動作する
- [ ] スキーマ初期化とマイグレーション機能が動作する
- [ ] 基本的なCRUD操作（Create/Read/Update/Delete）が実装されている
- [ ] トランザクション管理機能が実装されている
- [ ] エラーハンドリングが適切に実装されている（接続エラー・SQL実行エラー）
- [ ] 全テストケースが通過する（最低85%カバレッジ）
- [ ] パフォーマンス基準を満たしている（接続時間・クエリ応答時間）
- [ ] メモリ使用量が要件を満たしている
- [ ] ドキュメント（Rustdoc・コメント）が更新されている
- [ ] 既存機能（Task 3.2実装済み）との統合が完了している

## 📝 レビューチェックリスト

### コード品質
- [ ] Rustの所有権・借用チェッカーに準拠している
- [ ] エラーハンドリングが適切に実装されている（Result型使用）
- [ ] メモリ安全性が保証されている（unsafe使用なし）
- [ ] 日本語コメントが適切に記述されている

### アーキテクチャ準拠
- [ ] Task 3.2で実装されたスキーマとの整合性が保たれている
- [ ] データモデル（models/mod.rs）との連携が適切に実装されている
- [ ] レイヤー分離が適切に実装されている（Repository・Service層）
- [ ] 技術仕様書のデータベース仕様に準拠している

### パフォーマンス
- [ ] 接続プールが効率的に実装されている
- [ ] クエリの実行時間が要件を満たしている
- [ ] メモリ使用量が適切に管理されている
- [ ] インデックスが適切に活用されている

### セキュリティ
- [ ] SQLインジェクション対策が実装されている（プリペアドステートメント使用）
- [ ] 認証情報のメモリ上での適切な管理
- [ ] ファイルアクセス権限の適切な設定

## 🚀 実装開始の準備状況

### 利用可能な既存資産（Task 3.2完了分）
- ✅ **完全なスキーマ定義**: `INIT_SCHEMA`（6テーブル・9インデックス）
- ✅ **マイグレーション機能**: `MIGRATION_V1_TO_V2`（データ移行ロジック）
- ✅ **統合データモデル**: 5つの主要構造体（技術仕様書準拠）
- ✅ **バージョン管理**: `DB_VERSION = 2`とバージョンテーブル

### 開発効率向上要因
1. **スキーマ設計完了**: テーブル構造とリレーションシップが確定済み
2. **データモデル統合**: Rust構造体とSQLスキーマの整合性確保済み
3. **マイグレーション対応**: 既存データからの移行パス確立済み
4. **技術仕様準拠**: 設計ドキュメントとの100%整合性

### 推定工数短縮効果
- **従来予定**: 1日（スキーマ設計 + 実装）
- **現在必要**: 0.5日（接続・CRUD実装のみ）
- **短縮効果**: 50%（Task 3.2の先行実装により）

この実装計画により、ProjectLensのデータ永続化基盤が完成し、後続のタスクで必要となる安定したストレージサービスを提供できます。