# /rollback-task

## 概要
タスク実装を安全にロールバックし、タスク専用ブランチを削除して以前の状態に戻すコマンド

## 引数
- `task-number` (必須): ロールバック対象のタスク番号 (例: 2.1, 3.2)

## 設定・環境変数
- `KIRO_SPECS_DIR`: 仕様書ディレクトリ (デフォルト: `.kiro/specs/multi-project-dashboard`)
- `TASKS_FILE`: タスクファイル名 (デフォルト: `tasks.md`)

## 実行内容

### 1. 現状確認とバリデーション
- 現在のブランチ確認: `git branch --show-current`
- タスクブランチの存在確認: `git branch --list task-$1`
- 未コミットの変更確認: `git status --porcelain`
- タスク番号の妥当性確認

### 2. 安全性チェック
```
🔍 ロールバック前チェック (Task $1)

現在のブランチ: task-2.1
未コミット変更: 3ファイル
リモートブランチ: 存在する/存在しない

⚠️  以下の操作が実行されます：
1. 未コミット変更の退避 (必要に応じて)
2. developブランチへの切り替え
3. task-$1 ブランチの削除 (ローカル・リモート)
4. タスクステータスの更新
5. 関連ファイルの整理

続行しますか？ [Y/n/backup]:
```

### 3. 段階的ロールバック実行

#### ステップ1: 作業内容の保護
未コミット変更がある場合の処理オプション：
- `stash`: 一時保存 (`git stash push -m "Rollback task-$1 backup"`)
- `commit`: 緊急コミット作成
- `discard`: 変更を破棄
- `cancel`: ロールバック中止

#### ステップ2: ブランチ切り替え
- `git checkout develop`
- `git pull origin develop` (最新状態に更新)

#### ステップ3: タスクブランチ削除
- ローカルブランチ削除: `git branch -D task-$1`
- リモートブランチ削除: `git push origin --delete task-$1` (存在する場合)

#### ステップ4: 関連データの整理
- `${KIRO_SPECS_DIR}/${TASKS_FILE}` のタスクステータス更新 ([x] → [ ])
- 実装ログの移動: `_docs/implement-tasks/` → `_docs/rollback-logs/`
- 計画ファイルの保持: `_docs/task-plans/` は維持

### 4. ロールバック完了処理
```
✅ ロールバック完了 (Task $1)

実行された操作:
- ✅ developブランチに切り替え
- ✅ task-$1 ブランチを削除 (ローカル・リモート)
- ✅ タスクステータスを未完了に更新
- ✅ 実装ログをアーカイブ

現在の状態:
- ブランチ: develop
- 変更: なし
- タスク $1: 未完了状態

次のアクション:
- 再実装する場合: /implement-task $1
- 計画を見直す場合: /plan-implement-task $1
```

### 5. エラーハンドリング

#### タスクブランチが存在しない場合
```
❌ エラー: タスクブランチ 'task-$1' が見つかりません

利用可能なタスクブランチ:
- task-1.2
- task-3.1
- task-4.5

正しいタスク番号を確認してください。
```

#### リモートブランチの削除に失敗した場合
```
⚠️  リモートブランチの削除に失敗しました
原因: 権限不足またはネットワークエラー

対処法:
1. 手動削除: git push origin --delete task-$1
2. GitHubのWebUIで削除
3. 無視して続行 (ローカルは削除済み)
```

#### 未コミット変更の処理
```
⚠️  未コミットの変更があります (3ファイル)

処理方法を選択してください:
1. [stash] 一時保存してロールバック実行
2. [commit] 緊急コミットを作成してからロールバック  
3. [backup] バックアップブランチを作成してからロールバック
4. [discard] 変更を破棄してロールバック実行
5. [cancel] ロールバックを中止

選択: [1/2/3/4/5]:
```

## 使用例
```bash
# 基本的なロールバック
/rollback-task 2.1

# 強制実行（危険）
/rollback-task 2.1 --force

# バックアップ付きロールバック
/rollback-task 2.1 --backup
```

## 出力ファイル
- ロールバックログ: `_docs/rollback-logs/rollback-task-{task-number}-{timestamp}.md`
- 実装ログのアーカイブ: `_docs/rollback-logs/archived-implement-logs/`
- バックアップ（オプション）: `_backups/task-{task-number}-{timestamp}/`

## 安全機能
- **段階的確認**: 重要な操作の前に必ず確認
- **データ保護**: 未コミット変更の保護オプション
- **バックアップオプション**: 必要に応じて完全バックアップ
- **状態検証**: 各ステップ後の状態確認
- **復旧可能**: アーカイブされたログから情報を復元可能

## 制限事項
- マージ済みのタスクのロールバックは推奨されません
- リモートで共有されているブランチの削除は慎重に行ってください
- 依存関係のあるタスクへの影響は別途確認が必要です